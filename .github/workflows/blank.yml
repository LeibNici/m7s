name: Check Latest Release

on:
  push:
    branches:
      - main

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest release version
        id: latest_release
        run: |
          latest_release=$(curl --silent 'https://api.github.com/repos/langhuihui/monibuca/releases/latest' | jq -r '.tag_name')
          echo "::set-output name=release::${latest_release}"
          echo "Latest release version is $latest_release"
      - name: Check if release version has changed
        id: version_changed
        run: |
          current_release="${{ steps.latest_release.outputs.release }}"
          last_release="${{ env.LAST_RELEASE }}"
          if [ "$current_release" != "$last_release" ]; then
            echo "Release version has changed from $last_release to $current_release"
            echo "::set-env name=LAST_RELEASE::$current_release"
          else
            echo "Release version has not changed"
          fi
      - name: Download release
        if: steps.version_changed.outputs.version_changed == 'true'
        run: |
          curl -L "$(curl --silent 'https://api.github.com/repos/langhuihui/monibuca/releases/latest' | jq -r '.assets[] | select(.name | endswith(".tar.gz")).browser_download_url')" -o release.tar.gz
name: Check Latest Release

on:
  push:
    branches:
      - main

jobs:
  check-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check latest release version
        id: latest_release
        run: |
          latest_release=$(curl --silent 'https://api.github.com/repos/langhuihui/monibuca/releases/latest' | jq -r '.tag_name')
          echo "::set-output name=release::${latest_release}"
      - name: Display latest release version
        run: echo "Latest release version is ${{ steps.latest_release.outputs.release }}"
      - name: Check if release version has changed
        id: version_changed
        run: |
          if [ "${{ steps.latest_release.outputs.release }}" != "${{ env.LAST_RELEASE }}" ]; then
            echo "Release version has changed!"
            echo "::set-env name=LAST_RELEASE::${{ steps.latest_release.outputs.release }}"
          else
            echo "Release version has not changed"
          fi
      - name: Download release
        if: steps.version_changed.outputs.version_changed == 'true'
        run: |
          curl -L "$(curl --silent 'https://api.github.com/repos/langhuihui/monibuca/releases/latest' | jq -r '.assets[] | select(.name | endswith(".tar.gz")).browser_download_url')" -o release.tar.gz
